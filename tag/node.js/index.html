<!DOCTYPE html><html lang="en"><head><title>node.js - selfcontained</title><meta name="keywords" content="software,web development,brad harris"><meta name="author" content="Brad Harris"><meta name="robots" content="index,follow"><meta name="viewport" content="width=device-width,initial-scale=1"><link href="/css/blog.css" rel="stylesheet"><link rel="alternate" type="application/rss+xml" title="selfcontained Â» rss" href="http://www.selfcontained.us/feed/rss.xml"></head><body><div id="main"><header><h1><a href="/">selfcontained</a><small>[web development]</small></h1></header><div id="content-container"><section id="content"><h2>Articles tagged with <i>"node.js"</i> (6)</h2><article><h2><a href="/2013/09/14/flipflop-0.1.0-configurable-urls">flipflop 0.1.0 - configurable urls</a></h2><div class="meta"><ul class="tags"><li><a href="/tag/javascript">javascript</a></li><li><a href="/tag/flipflop">flipflop</a></li><li><a href="/tag/node.js">node.js</a></li></ul><img src="http://www.gravatar.com/avatar/c20763ec853bb1d2eb3e8a08cc5a28b9?s=30.jpg" width="30" height="30"><div class="date">Saturday September 14, 2013</div><div class="name">By Brad Harris</div></div><div class="content"><p>I released a new version of <a href="http://github.com/selfcontained/flipflop">flipflop</a> that has support for configurable urls.  Details are in the <a href="http://github.com/selfcontained/flipflop/blob/master/README.md#configuring-routes--urls">readme file</a>, but in short, when you generate a new flipflop blog, part of the config in the <code>blog.json</code> file will now include a section for <code>routes</code>.  If you have an existing flipflop blog and want to update to the latest, you can add this section to your <code>blog.json</code> config file.  You may also want/need to update a few of your templates, depending on how much you&#39;ve changed them.  Check <a href="http://github.com/selfcontained/selfcontained_blog/commit/6b15e6e5f0b2981a8d3868f5862809dadaf32ebf">this commit</a> to see an example of what changes to make.

</p>
<pre><code class="lang-javascript">&quot;routes&quot;: {
    &quot;archive&quot;: &quot;/archive&quot;,
    &quot;article&quot;: &quot;/:year/:month/:day/:slug&quot;,
    &quot;error&quot;: &quot;/404.html&quot;,
    &quot;homepage&quot;: &quot;/&quot;,
    &quot;feed&quot;: &quot;/feed/rss.xml&quot;,
    &quot;tag&quot;: &quot;/tag/:tag&quot;
}</code></pre>
<p>This will allow for customizing the url, such as adding a prefix to your blog:

</p>
<pre><code class="lang-javascript">&quot;routes&quot;: {
    &quot;archive&quot;: &quot;/blog/archive&quot;,
    &quot;article&quot;: &quot;/blog/:year/:month/:day/:slug&quot;,
    &quot;error&quot;: &quot;/blog/404.html&quot;,
    &quot;homepage&quot;: &quot;/blog&quot;,
    &quot;feed&quot;: &quot;/blog/feed/rss.xml&quot;,
    &quot;tag&quot;: &quot;/blog/tag/:tag&quot;
}</code></pre>
<p>There are a few special things to note with routes:

</p>
<ul>
<li>The <strong>article</strong> route requires a <code>:slug</code> param.  Available params are:<ul>
<li><code>:year</code></li>
<li><code>:month</code></li>
<li><code>:day</code></li>
<li><code>:slug</code> (required)</li>
</ul>
</li>
<li>The <strong>tag</strong> route requires a <code>:tag</code> param.  Available params are:<ul>
<li><code>:tag</code> (required)</li>
</ul>
</li>
</ul>

</div></article><article><h2><a href="/2012/09/20/using-express-with-broadway">using express with broadway</a></h2><div class="meta"><ul class="tags"><li><a href="/tag/javascript">javascript</a></li><li><a href="/tag/node.js">node.js</a></li><li><a href="/tag/broadway">broadway</a></li><li><a href="/tag/express">express</a></li></ul><img src="http://www.gravatar.com/avatar/c20763ec853bb1d2eb3e8a08cc5a28b9?s=30.jpg" width="30" height="30"><div class="date">Thursday September 20, 2012</div><div class="name">By Brad Harris</div></div><div class="content"><p><a href="http://expressjs.com/">Express</a> is by no doubt an extremely popular http application server/framework for node.js.  In this article I&#39;d like to demonstrate how you can take advantage of <a href="https://github.com/flatiron/broadway">broadway</a> and <a href="http://expressjs.com/">express</a> together.

</p>
<p>In this approach, we&#39;ll treat the <em>http server</em> that <code>express</code> provides as just another plugin to our <code>broadway</code> application.

</p>
<h2>express http plugin</h2>
<p>First we&#39;ll create an http plugin encapsulating express.

</p>
<pre><code class="lang-javascript"><span class="comment">// http.js</span>

<span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>);

<span class="keyword">var</span> HttpPlugin = exports;

HttpPlugin.name = <span class="string">'http'</span>;

HttpPlugin.attach = <span class="keyword">function</span>(options) {
    <span class="keyword">var</span> app = <span class="keyword">this</span>;

    <span class="keyword">var</span> server = app.http = express();
    server.<span class="keyword">use</span>(server.router);

    <span class="keyword">require</span>(<span class="string">'./routes'</span>)(app);
};

HttpPlugin.init = <span class="keyword">function</span>(done) {
    done();
};</code></pre>
<p>I&#39;d also suggest defining your routes in their own module(s), and passing along the broadway application.  This will allow them to take full advantage of any other functionality your application acquires through other plugins.

</p>
<pre><code class="lang-javascript"><span class="comment">// routes.js</span>
module.exports = <span class="keyword">function</span>(app) {

    app.http.get(<span class="string">'/'</span>, <span class="keyword">function</span>(req, res){
        res.send(<span class="string">'express on broadway'</span>);
    });

};</code></pre>
<h2>broadway.concat(express)</h2>
<p>Next we&#39;ll create a broadway application and toss in our http plugin.

</p>
<pre><code class="lang-javascript"><span class="comment">// app.js</span>

<span class="keyword">var</span> broadway = <span class="keyword">require</span>(<span class="string">'broadway'</span>),
    app = <span class="keyword">new</span> broadway.App();

app.<span class="keyword">use</span>(<span class="keyword">require</span>(<span class="string">'./http'</span>));

app.init(<span class="keyword">function</span>(err) {
    app.http.listen(<span class="number">8080</span>);
});</code></pre>
<p>You can also just <code>module.exports = app.http</code> if you&#39;re using something like <code>up</code> and need to export an http server from your main applicaiton.

</p>
<h2>krakens.release()</h2>
<p>Finally, fire up your application

</p>
<pre><code>&gt;node app.js</code></pre>
<p>That&#39;s all there is to it.  In this example, the http server is just one piece of our application, and we can bolt on additional functionality as needed through more plugins.


</p>

</div></article><article><h2><a href="/2012/09/18/decoupling-your-node-js-application-with-broadway">decoupling your node.js application with broadway</a></h2><div class="meta"><ul class="tags"><li><a href="/tag/javascript">javascript</a></li><li><a href="/tag/node.js">node.js</a></li><li><a href="/tag/broadway">broadway</a></li><li><a href="/tag/decoupling">decoupling</a></li></ul><img src="http://www.gravatar.com/avatar/c20763ec853bb1d2eb3e8a08cc5a28b9?s=30.jpg" width="30" height="30"><div class="date">Tuesday September 18, 2012</div><div class="name">By Brad Harris</div></div><div class="content"><h2>the why</h2>
<p>Why should you worry about decoupling your node.js application?  Can&#39;t you just use the module pattern and <code>require()</code> away?  Sure, sort of...until your application starts to grow, and module&#39;s begin to have cross dependencies.  In reality, you can avoid cross dependencies between modules for most small to medium sized applications, but as your application grows, you may run into <a href="/2012/05/08/node-js-circular-dependencies/">cyclic</a> <a href="http://nodejs.org/api/modules.html#modules_cycles">dependencies</a>, which can be hard to decipher and debug.  Without going into detail on what those are (follow those links if you&#39;re wondering), I present, a contrived example.


</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> ModuleA = <span class="keyword">require</span>(<span class="string">'module-a'</span>),
    ModuleB = <span class="keyword">require</span>(<span class="string">'module-b'</span>);

<span class="keyword">var</span> ModuleC = module.exports = <span class="keyword">function</span>() {
    <span class="keyword">this</span>.myB = <span class="keyword">new</span> ModuleB();
};

ModuleC.prototype = {

    <span class="comment">/** amazin' function! */</span>
    amazinFunction : <span class="keyword">function</span>() {
        <span class="keyword">if</span>(ModuleA.isAmazin(<span class="keyword">this</span>.myB) {
            <span class="keyword">this</span>.beginAwesomness();
        }<span class="keyword">else</span> {
            <span class="keyword">this</span>.sadPanda();
        }
    },

    beginAwesomness : <span class="keyword">function</span>() { <span class="comment">/** awesome stuff */</span> },

    sadPanda : <span class="keyword">function</span>() { <span class="comment">/** sad stuff */</span> }

};</code></pre>
<p>Here <code>ModuleC</code> is exported, and is a pretty basic function/prototype that has some required dependencies.  The principle of dependency injection would tell us that instead of ModuleC being responsible for loading ModuleA and ModuleB, those should be injected into it somehow.  <a href="http://github.com/flatiron/broadway">Broadway</a> is a fantastic library to help with this.

</p>
<h2>broadway</h2>
<p>At it&#39;s core, <a href="http://github.com/flatiron/broadway">Broadway</a> provides a plugin architecture for applications, and a consistent way to manage and add functionality.  It also gives us a nice platform for dependency injection, and inversion of control, letting the modules alter and build on the application instead of the application being responsible to build everything and pull in your modules&#39; functionality.  If you&#39;re interested in this concept, <a href="http://blog.nodejitsu.com/ioc-and-dependency-injection-with-broadway">this article</a> from the Nodejitsu blog is super informative.

</p>
<p>So, let&#39;s start with a basic Broadway application, and load up a plugin that we&#39;ll define below.

</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> broadway = <span class="keyword">require</span>(<span class="string">'broadway'</span>),
    app = <span class="keyword">new</span> broadway.App();

app.<span class="keyword">use</span>(<span class="keyword">require</span>(<span class="string">'myposse'</span>));

app.init(<span class="keyword">function</span>(err) {
    <span class="comment">// we're all setup, gtg</span>
});</code></pre>
<p>A basic Broadway plugin might look something like...

</p>
<pre><code class="lang-javascript"><span class="comment">// myposse.js</span>

<span class="keyword">var</span> MyPosse = exports;

MyPosse.name = <span class="string">'myposse'</span>;

MyPosse.attach = <span class="keyword">function</span>(options) {
    <span class="keyword">var</span> app = <span class="keyword">this</span>;

    <span class="comment">// here we can add some functionality to the app</span>
    app.posse = <span class="keyword">function</span>() {
        console.log(<span class="string">"my posse's on broadway"</span>);
    };
};

MyPosse.init = <span class="keyword">function</span>(done) {
    <span class="comment">// handle any asynchronous initilization</span>
    done();
};</code></pre>
<p>RIP MCA.  Inside our <code>attach</code> function is where we can pull in our related modules, and expose them to the application.  Notice how we&#39;re calling the result of the require statement of each module, passing in the Broadway application, and setting that onto the application itself.

</p>
<pre><code class="lang-javascript">MyPosse.attach = <span class="keyword">function</span>(options) {
    <span class="keyword">var</span> app = <span class="keyword">this</span>;

    app.ModuleA = <span class="keyword">require</span>(<span class="string">'module-a'</span>)(app);
    app.ModuleB = <span class="keyword">require</span>(<span class="string">'module-b'</span>)(app);
    app.ModuleC = <span class="keyword">require</span>(<span class="string">'module-c'</span>)(app);

};</code></pre>
<p>We would want to rework our above example of ModuleC to allow for this change, which also lets us remove the require statements for ModuleA and ModuleB, and pull them in as dependencies from the <code>app</code> object.

</p>
<pre><code class="lang-javascript">module.exports = <span class="keyword">function</span>(app) {

    <span class="keyword">var</span> ModuleA = app.ModuleA,
        ModuleB = app.ModuleB;

    <span class="keyword">var</span> ModuleC = <span class="keyword">function</span>() {
        <span class="keyword">this</span>.myB = <span class="keyword">new</span> ModuleB();
    };

    ModuleC.prototype = {

        <span class="comment">/** amazin' function! */</span>
        amazinFunction : <span class="keyword">function</span>() {
            <span class="keyword">if</span>(ModuleA.isAmazin(<span class="keyword">this</span>.myB) {
                <span class="keyword">this</span>.beginAwesomness();
            }<span class="keyword">else</span> {
                <span class="keyword">this</span>.sadPanda();
            }
        },

        beginAwesomness : <span class="keyword">function</span>() { <span class="comment">/** awesome stuff */</span> },

        sadPanda : <span class="keyword">function</span>() { <span class="comment">/** sad stuff */</span> }

    };

    <span class="keyword">return</span> ModuleC;

};</code></pre>
<p>With Broadway you can organize your application&#39;s modules and expose their functionality to the application via plugins.  I&#39;ve found it a great way to organize services, models, and other application resources, and expose them to the application without coupling them directly to eachother via <code>require</code> statements.  There&#39;s definitely a place for modules that are independant enough to be <code>require()&#39;d</code> at will, but I&#39;ve also found that there&#39;s a place for application specific modules that are best managed at an application level.

</p>
<p>There&#39;s a lot more <a href="http://github.com/flatiron/broadway">Broadway</a> has to offer (such as application events), so check it out if you&#39;re building large applications on node.js.


</p>

</div></article><article><h2><a href="/2012/05/08/node-js-circular-dependencies">node.js and circular dependencies</a></h2><div class="meta"><ul class="tags"><li><a href="/tag/node.js">node.js</a></li><li><a href="/tag/javascript">javascript</a></li></ul><img src="http://www.gravatar.com/avatar/c20763ec853bb1d2eb3e8a08cc5a28b9?s=30.jpg" width="30" height="30"><div class="date">Tuesday May 8, 2012</div><div class="name">By Brad Harris</div></div><div class="content"><p>Circular Dependencies in modules can be tricky, and hard to debug in <a href="http://nodejs.org">node.js</a>.  If module <code>A</code> <code>requires(&#39;B&#39;)</code> before it has finished setting up it&#39;s exports, and then module <code>B</code> <code>requires(&#39;A&#39;)</code>, it will get back an empty object instead what <code>A</code> may have intended to export.  It makes logical sense that if the export of <code>A</code> wasn&#39;t setup, requiring it in <code>B</code> results in an empty export object.  All the same, it can be a pain to debug, and not inherently obvious to developers used to having those circular dependencies handled automatically.  Fortunately, there are rather simple approaches to resolving the issue.

</p>
<h2>example.broken() === true</h2>
<p>Let&#39;s define a broken scenario to clearly illustrate the issue.  Module <code>A</code> delegates to an instance of Module <code>B</code> to <code>do some important stuff()</code>.

</p>
<h3>Module A</h3>
<pre><code class="lang-javascript"><span class="keyword">var</span> B = <span class="keyword">require</span>(<span class="string">'./B'</span>),
    id,
    bInstance;

<span class="keyword">var</span> A = module.exports = {
    init : <span class="keyword">function</span>(val) {
        id = val;
        bInstance = <span class="keyword">new</span> B();
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    doStuff : <span class="keyword">function</span>() {
        bInstance.stuff();
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    getId : <span class="keyword">function</span>() {
        <span class="keyword">return</span> id;
    }
};</code></pre>
<h3>Module B</h3>
<pre><code class="lang-javascript"><span class="keyword">var</span> A = <span class="keyword">require</span>(<span class="string">'./A'</span>);

<span class="keyword">var</span> B = module.exports = <span class="keyword">function</span>(){
    <span class="keyword">return</span> {
        stuff : <span class="keyword">function</span>() {
            console.log(<span class="string">'I got the id: '</span>, A.getId());
        }
    };
};</code></pre>
<h3>Tie them together</h3>
<pre><code class="lang-javascript"><span class="keyword">require</span>(<span class="string">'./A.js'</span>)
    .init(<span class="number">1234</span>)
    .doStuff();</code></pre>
<p>With this you&#39;ll end up with an error:
</p>
<pre><code class="lang-javascript">TypeError: Object <span class="comment">#&lt;Object> has no method 'getId'</span>
    at Object.stuff (/Users/bharris/workspace/circular-dep/B.js:<span class="number">7</span>:<span class="number">36</span>)
    at Object.doStuff (/Users/bharris/workspace/circular-dep/A.js:<span class="number">18</span>:<span class="number">13</span>)
    at Object.&lt;anonymous> (/Users/bharris/workspace/circular-dep/test.js:<span class="number">4</span>:<span class="number">3</span>)</code></pre>
<p>The issue is that when <code>A</code> is required at the top of <code>B</code>, it ends up being an empty object, which doesn&#39;t have a <code>getId</code> method.

</p>
<h2>example.solutions().length === 2</h2>
<p>I&#39;ll explain two simple solutions to this issue:

</p>
<ul>
<li><a href="#delay">delay invocation of dependency until runtime</a></li>
<li><a href="#inject">replace circular dependency with dependency injection</a></li>
</ul>
<p><a name="delay"></a>
</p>
<h2>delay invocation of dependency until runtime</h2>
<p>If we move the require statements to where they are needed at runtime, it will delay the execution of them, allowing for the exports to have been created properly.  In this example, we can get away with simply moving the <code>require(&#39;./B&#39;)</code> statement.

</p>
<h3>Module A</h3>
<pre><code class="lang-javascript"><span class="keyword">var</span> id,
    bInstance;

<span class="keyword">var</span> A = module.exports = {
    init : <span class="keyword">function</span>(val) {
        id = val;
        bInstance = <span class="keyword">new</span> <span class="keyword">require</span>(<span class="string">'./B'</span>)();
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    doStuff : <span class="keyword">function</span>() {
        bInstance.stuff();
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    getId : <span class="keyword">function</span>() {
        <span class="keyword">return</span> id;
    }
};</code></pre>
<p>This feels like a bit of bandaid to this particular problem, but perhaps is the right solution in some cases.

</p>
<p><a name="inject"></a>
</p>
<h2>replace circular dependency with dependency injection</h2>
<p>The only dependecy that <code>B</code> currently has on <code>A</code> is an id property it needs access to.  We could just pass the id into the constructor of <code>B</code>, but let&#39;s assume <code>A</code> is more significant to the operations <code>B</code> must perform, and a proper reference is required.  If we inject that dependency we&#39;ll allow for a loose coupling between the two modules, and have a slightly more elegant solution.  Zing!

</p>
<h3>Module A</h3>
<pre><code class="lang-javascript"><span class="keyword">var</span> B = <span class="keyword">require</span>(<span class="string">'./B'</span>),
    id,
    bInstance;

<span class="keyword">var</span> A = module.exports = {
    init : <span class="keyword">function</span>(val) {
        id = val;
        bInstance = <span class="keyword">new</span> B(<span class="keyword">this</span>);
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    getId : <span class="keyword">function</span>() {
        <span class="keyword">return</span> id;
    },

    doStuff : <span class="keyword">function</span>() {
        bInstance.stuff();
        <span class="keyword">return</span> <span class="keyword">this</span>;
    }
};</code></pre>
<h3>Module B</h3>
<pre><code class="lang-javascript"><span class="keyword">var</span> B = module.exports = <span class="keyword">function</span>(val){
    <span class="keyword">var</span> dependency = val;
    <span class="keyword">return</span> {
        stuff : <span class="keyword">function</span>() {
            console.log(<span class="string">'I got the id: '</span>, dependency.getId());
        }
    };

};</code></pre>
<h3>#winning</h3>
<pre><code class="lang-javascript">DependencyInjection
    .merge(LooseCoupling)
    .attach($);</code></pre>
<p>I put my <code>$</code> on <a href="http://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> and <a href="http://en.wikipedia.org/wiki/Loose_coupling">loose coupling</a>.

</p>

</div></article><article><h2><a href="/2012/04/14/makdown-powered-blogs">markdown powered blogs</a></h2><div class="meta"><ul class="tags"><li><a href="/tag/markdown">markdown</a></li><li><a href="/tag/node.js">node.js</a></li><li><a href="/tag/javascript">javascript</a></li><li><a href="/tag/less">less</a></li></ul><img src="http://www.gravatar.com/avatar/c20763ec853bb1d2eb3e8a08cc5a28b9?s=30.jpg" width="30" height="30"><div class="date">Saturday April 14, 2012</div><div class="name">By Brad Harris</div></div><div class="content"><p>Switching from a complex blogging platform to a lightweight, file-based blog is something of a trend amongst web developers lately.  I chalk it up to our love of simple solutions, and a preference of interfacing directly with a file-system.  I much prefer to open up <a href="http://www.sublimetext.com/2">SublimeText2</a>, go into <a href="http://www.sublimetext.com/docs/2/distraction_free.html">distraction free</a> mode and create a <a href="http://daringfireball.net/projects/markdown/syntax">markdown</a> file for a new article.  For me it&#39;s a smaller barrier of entry to writing than logging into Worpress and gathering my thoughts in a <code>&lt;textarea&gt;</code>.

</p>
<h2>what&#39;s out there</h2>
<p><a href="https://github.com/mojombo/jekyll">There</a> <a href="https://github.com/creationix/wheat">are</a> <a href="https://github.com/flatiron/blacksmith">some</a> great options out there for markdown based blogs.  My preference is towards <a href="http://nodejs.org">node.js</a>, and <a href="https://github.com/creationix/wheat">Wheat</a> (created by <a href="https://github.com/creationix">Tim Caswell</a>) as a platform for <a href="http://howtonode.org/">howtonode.org</a> is one of the more popular solutions in that category.  <a href="https://github.com/flatiron/blacksmith">Blacksmith</a> is another great solution, created by <a href="http://nodejitsu.com/">nodejitsu</a>.  Both are interesting and powerful solutions, but weren&#39;t exactly what I wanted.

</p>
<h2>javascript is easy</h2>
<p>I wanna be in control of the urls for articles, use the templating engine I prefer, and have some fun writing javascript.  I also want to be able to start my blog up locally on a node http server to tweak it and test it, and not have to generate the static site to view every change.  For the live site, I want to just <a href="https://github.com/selfcontained/selfcontained_blog">clone a git repo</a> on a server, and run <code>&gt; node generate.js</code> to create a static site for Apache to serve.  <a href="https://github.com/selfcontained/selfcontained_blog">So I did</a>, it was fun.  Feel free to check it out, maybe <a href="https://github.com/selfcontained/selfcontained_blog">fork</a> it and see what you think.

</p>
<h2>i can haz dropbox blog?</h2>
<p><a href="http://joehewitt.com/2011/10/03/dropbox-is-my-publish-button">Check out</a> what <a href="https://github.com/joehewitt">Joe Hewitt</a> is doing to integrate <a href="http://dropbox.com">Dropbox</a> into his blogging solution.  I dig it.

</p>

</div></article><article><h2><a href="/2012/04/04/node-js-clusters">node.js clusters</a></h2><div class="meta"><ul class="tags"><li><a href="/tag/node.js">node.js</a></li><li><a href="/tag/javascript">javascript</a></li></ul><img src="http://www.gravatar.com/avatar/c20763ec853bb1d2eb3e8a08cc5a28b9?s=30.jpg" width="30" height="30"><div class="date">Wednesday April 4, 2012</div><div class="name">By Brad Harris</div></div><div class="content"><p>When it comes time to deploy a <a href="http://nodejs.org">node.js</a> application, you&#39;ll want to examine how you can benefit from your hardware and take advantage of multiple cpus.  Node is single threaded, so having one process run your application on a server with more than one cpu isn&#39;t optimal.  Fortunately, like many things on node, it&#39;s simple to do so.

</p>
<p>Let&#39;s take the following example of a dead simple http server:

</p>
<pre><code class="lang-javascript">    <span class="keyword">require</span>(<span class="string">'http'</span>).createServer(<span class="keyword">function</span>(req, res) {
        res.writeHead(<span class="number">200</span>);
        res.end(<span class="string">'this is dead simple'</span>);
    }).listen(<span class="number">3001</span>);</code></pre>
<p>You&#39;ve got that saved in a file, let&#39;s call it <em>app.js</em>.  You start it up...

</p>
<pre><code>    &gt; node app.js</code></pre>
<p>...and it&#39;s amazing, it writes out text to all those that visit your site, just like you want.  It&#39;s become an overnight internet sensation, and now you want to know what crazy hoops you&#39;ll have to jump through to scale it up and take advantage of all the cpus on your server.  Enter the <a href="http://nodejs.org/docs/latest/api/cluster.html">cluster</a> module.

</p>
<p>We&#39;ll create a new file that we&#39;ll use in production to launch our application.  Let&#39;s call it <code>cluster.js</code>.

</p>
<pre><code class="lang-javascript">    <span class="keyword">var</span> cluster = <span class="keyword">require</span>(<span class="string">'cluster'</span>);

    <span class="keyword">if</span> (cluster.isMaster) {
        <span class="comment">//start up workers for each cpu</span>
        <span class="keyword">require</span>(<span class="string">'os'</span>).cpus().<span class="keyword">forEach</span>(<span class="keyword">function</span>() {
            cluster.fork();
        });

    } <span class="keyword">else</span> {
        <span class="comment">//load up your application as a worker</span>
        <span class="keyword">require</span>(<span class="string">'./app.js'</span>);
    }</code></pre>
<p>When you start your app now...

</p>
<pre><code>    &gt; node cluster.js</code></pre>
<p>...node will recognize that the cluster is the master, and then you simply fork the cluster for each cpu you have.  Those in turn will start up, and those workers won&#39;t be the master, so they&#39;ll just load up your <code>app.js</code> and start up a process for each cpu.

</p>
<p>But wait, doesn&#39;t each worker have to listen on a different port?

</p>
<blockquote>
<p>   &quot;The cluster module allows you to easily create a network of processes that all share server ports.&quot;

</p>
</blockquote>
<p>One TCP server is shared between all workers, so they can all be listening on the same port.

</p>
<p>Awesome, you&#39;re now handling loads of traffic, but after a day you realize two of your workers died because you had an exception being thrown in that complex codebase of yours.  How can you make sure you keep them running?

</p>
<pre><code class="lang-javascript">    <span class="keyword">if</span>(cluster.isMaster) {
        <span class="comment">//start up workers for each cpu</span>
        <span class="keyword">require</span>(<span class="string">'os'</span>).cpus().<span class="keyword">forEach</span>(<span class="keyword">function</span>() {
            cluster.fork();
        });

        cluster.on(<span class="string">'death'</span>, <span class="keyword">function</span>(worker) {
            console.log(<span class="string">'worker '</span> + worker.pid + <span class="string">' died'</span>);
            cluster.fork();
        });
    }</code></pre>
<p>Listen for the &#39;death&#39; event on the cluster, and just fork a new worker if one dies.  Simple huh?  Keep in mind, every worker is it&#39;s own process, therefor they don&#39;t share memory.

</p>

</div></article></section><aside class="sidebar"><div class="about"><img src="/images/bradharris.gif" width="100" height="100" align="left"><p>	My name is Brad Harris and I'm an engineer @ Yahoo!
	I love architecting software and developing simple and elegant solutions to complex problems. I
	've worked for companies on large enterprise projects, as well as smaller projects, and fine satisfaction across the board.
	I enjoy learning and applying new principles and patterns to my work.
</p></div><h3>recent articles</h3><ul><li><a href="/2013/09/14/flipflop-0.1.0-configurable-urls">flipflop 0.1.0 - configurable urls</a><div class="date">Saturday September 14, 2013</div></li><li><a href="/2012/09/20/using-express-with-broadway">using express with broadway</a><div class="date">Thursday September 20, 2012</div></li><li><a href="/2012/09/18/decoupling-your-node-js-application-with-broadway">decoupling your node.js application with broadway</a><div class="date">Tuesday September 18, 2012</div></li><li><a href="/2012/09/01/hello-fabric">hello fabric</a><div class="date">Saturday September 1, 2012</div></li><li><a href="/2012/05/08/node-js-circular-dependencies">node.js and circular dependencies</a><div class="date">Tuesday May 8, 2012</div></li><li><a href="/2012/04/27/backup-iphoto-with-google-drive">google.drive.backup(iphoto.library)</a><div class="date">Friday April 27, 2012</div></li><li><a href="/2012/04/14/makdown-powered-blogs">markdown powered blogs</a><div class="date">Saturday April 14, 2012</div></li><li><a href="/2012/04/04/node-js-clusters">node.js clusters</a><div class="date">Wednesday April 4, 2012</div></li><li><a href="/2011/07/08/markdown-me">markdown.me</a><div class="date">Friday July 8, 2011</div></li><li><a href="/2011/05/28/phpunit-mocks-and-closures">PHPUnit, Mocks and Closures</a><div class="date">Saturday May 28, 2011</div></li><li><a href="/2011/04/20/php-and-an-abstract-singleton">PHP and an abstract Singleton</a><div class="date">Wednesday April 20, 2011</div></li><li><a href="/2011/04/20/review-yahoo-user-interface-library-2-x-cookbook">Review: Yahoo! User Interface Library 2.x Cookbook</a><div class="date">Wednesday April 20, 2011</div></li><li><a href="/2011/02/28/awaiting-yahoo-user-interface-library-2-x-cookbook">Awaiting Yahoo! User Interface Library 2.x Cookbook</a><div class="date">Monday February 28, 2011</div></li><li><a href="/2011/01/23/latest-endeavor-whoopdwhoop-com">Latest Endeavor: whoopdwhoop.com</a><div class="date">Sunday January 23, 2011</div></li><li><a href="/2010/11/30/php-coalesce">?: PHP Coalesce</a><div class="date">Tuesday November 30, 2010</div></li><li><a href="/2010/11/19/yui-jquery">YUI =&gt; jQuery?</a><div class="date">Friday November 19, 2010</div></li><li><a href="/2010/10/22/yahoo-new-adventure">Yahoo!  A New Adventure</a><div class="date">Friday October 22, 2010</div></li><li><a href="/2010/09/04/yui-2-8-learning-the-library-book-review">YUI 2.8 Learning the Library book review</a><div class="date">Saturday September 4, 2010</div></li><li><a href="/2010/08/13/yui-2-8-learning-the-library-free-chapter">&quot;YUI 2.8: Learning the Library&quot; Free Chapter</a><div class="date">Friday August 13, 2010</div></li><li><a href="/2010/05/08/first-iphone-app-lds-gems">First iPhone App - LDS Gems</a><div class="date">Saturday May 8, 2010</div></li><li><a href="/2010/03/30/doctrine-model-hydration">Doctrine Model Hydration</a><div class="date">Tuesday March 30, 2010</div></li><li><a href="/2009/09/16/getting-keycode-values-in-javascript">Getting keycode values in Javascript</a><div class="date">Wednesday September 16, 2009</div></li><li><a href="/2009/01/23/scoping-javascript-closures-in-loops">Scoping Javascript closures in loops</a><div class="date">Friday January 23, 2009</div></li><li><a href="/2009/01/23/browser-autocomplete-and-keyup-events">Browser autocomplete and keyup events</a><div class="date">Friday January 23, 2009</div></li><li><a href="/2009/01/22/followup-on-yui-getfirstdescendantby">Followup on YUI : getFirstDescendantBy()</a><div class="date">Thursday January 22, 2009</div></li></ul><h3>links</h3><ul><li><a href="/archive">archive</a></li><li><a href="/feed/rss.xml">feed</a></li></ul></aside></div><footer>	&copy; 2012 Brad Harris |
	powered by
<a href="https://github.com/selfcontained/flipflop">flipflop</a></footer></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-254292-12']);
_gaq.push(['_trackPageview']);

(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script></body></html>