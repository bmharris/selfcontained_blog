<!DOCTYPE html><html lang="en"><head><title>node.js and circular dependencies</title><meta name="keywords" content="node.js,javascript"><meta name="author" content="Brad Harris"><meta name="robots" content="index,follow"><meta name="viewport" content="width=device-width,initial-scale=1"><link href="/css/blog.css" rel="stylesheet"><link rel="alternate" type="application/rss+xml" title="selfcontained Â» rss" href="http://www.selfcontained.us/feed/rss.xml"></head><body><div id="main"><header><h1><a href="/">selfcontained</a><small>[web development]</small></h1></header><div id="content-container"><aside class="sidebar"><div class="about"><img src="/images/bradharris.gif" width="100" height="100" align="left"><p>	My name is Brad Harris and I'm an engineer @ Yahoo!
	I love architecting software and developing simple and elegant solutions to complex problems. I
	've worked for companies on large enterprise projects, as well as smaller projects, and fine satisfaction across the board.
	I enjoy learning and applying new principles and patterns to my work.
</p></div><div class="recent-articles"><h3>recent articles</h3><ul><li><a href="/2013/09/14/flipflop-0.1.0-configurable-urls">flipflop 0.1.0 - configurable urls</a><div class="date">Saturday September 14, 2013</div></li><li><a href="/2012/09/20/using-express-with-broadway">using express with broadway</a><div class="date">Thursday September 20, 2012</div></li><li><a href="/2012/09/18/decoupling-your-node-js-application-with-broadway">decoupling your node.js application with broadway</a><div class="date">Tuesday September 18, 2012</div></li><li><a href="/2012/09/01/hello-fabric">hello fabric</a><div class="date">Saturday September 1, 2012</div></li><li><a href="/2012/05/08/node-js-circular-dependencies">node.js and circular dependencies</a><div class="date">Tuesday May 8, 2012</div></li><li><a href="/2012/04/27/backup-iphoto-with-google-drive">google.drive.backup(iphoto.library)</a><div class="date">Friday April 27, 2012</div></li><li><a href="/2012/04/14/makdown-powered-blogs">markdown powered blogs</a><div class="date">Saturday April 14, 2012</div></li><li><a href="/2012/04/04/node-js-clusters">node.js clusters</a><div class="date">Wednesday April 4, 2012</div></li><li><a href="/2011/07/08/markdown-me">markdown.me</a><div class="date">Friday July 8, 2011</div></li><li><a href="/2011/05/28/phpunit-mocks-and-closures">PHPUnit, Mocks and Closures</a><div class="date">Saturday May 28, 2011</div></li><li><a href="/2011/04/20/php-and-an-abstract-singleton">PHP and an abstract Singleton</a><div class="date">Wednesday April 20, 2011</div></li><li><a href="/2011/04/20/review-yahoo-user-interface-library-2-x-cookbook">Review: Yahoo! User Interface Library 2.x Cookbook</a><div class="date">Wednesday April 20, 2011</div></li><li><a href="/2011/02/28/awaiting-yahoo-user-interface-library-2-x-cookbook">Awaiting Yahoo! User Interface Library 2.x Cookbook</a><div class="date">Monday February 28, 2011</div></li><li><a href="/2011/01/23/latest-endeavor-whoopdwhoop-com">Latest Endeavor: whoopdwhoop.com</a><div class="date">Sunday January 23, 2011</div></li><li><a href="/2010/11/30/php-coalesce">?: PHP Coalesce</a><div class="date">Tuesday November 30, 2010</div></li><li><a href="/2010/11/19/yui-jquery">YUI =&gt; jQuery?</a><div class="date">Friday November 19, 2010</div></li><li><a href="/2010/10/22/yahoo-new-adventure">Yahoo!  A New Adventure</a><div class="date">Friday October 22, 2010</div></li><li><a href="/2010/09/04/yui-2-8-learning-the-library-book-review">YUI 2.8 Learning the Library book review</a><div class="date">Saturday September 4, 2010</div></li><li><a href="/2010/08/13/yui-2-8-learning-the-library-free-chapter">&quot;YUI 2.8: Learning the Library&quot; Free Chapter</a><div class="date">Friday August 13, 2010</div></li><li><a href="/2010/05/08/first-iphone-app-lds-gems">First iPhone App - LDS Gems</a><div class="date">Saturday May 8, 2010</div></li><li><a href="/2010/03/30/doctrine-model-hydration">Doctrine Model Hydration</a><div class="date">Tuesday March 30, 2010</div></li><li><a href="/2009/09/16/getting-keycode-values-in-javascript">Getting keycode values in Javascript</a><div class="date">Wednesday September 16, 2009</div></li><li><a href="/2009/01/23/scoping-javascript-closures-in-loops">Scoping Javascript closures in loops</a><div class="date">Friday January 23, 2009</div></li><li><a href="/2009/01/23/browser-autocomplete-and-keyup-events">Browser autocomplete and keyup events</a><div class="date">Friday January 23, 2009</div></li><li><a href="/2009/01/22/followup-on-yui-getfirstdescendantby">Followup on YUI : getFirstDescendantBy()</a><div class="date">Thursday January 22, 2009</div></li></ul></div><div class="links"><h3>links</h3><ul><li><a href="/archive">archive</a></li><li><a href="/feed/rss.xml">feed</a></li></ul></div></aside><section id="content"><article><h2><a href="/2012/05/08/node-js-circular-dependencies">node.js and circular dependencies</a></h2><div class="meta"><ul class="tags"><li><a href="/tag/node.js">node.js</a></li><li><a href="/tag/javascript">javascript</a></li></ul><img src="http://www.gravatar.com/avatar/c20763ec853bb1d2eb3e8a08cc5a28b9?s=30.jpg" width="30" height="30"><div class="date">Tuesday May 8, 2012</div><div class="name">By Brad Harris</div></div><div class="content"><p>Circular Dependencies in modules can be tricky, and hard to debug in <a href="http://nodejs.org">node.js</a>.  If module <code>A</code> <code>requires(&#39;B&#39;)</code> before it has finished setting up it&#39;s exports, and then module <code>B</code> <code>requires(&#39;A&#39;)</code>, it will get back an empty object instead what <code>A</code> may have intended to export.  It makes logical sense that if the export of <code>A</code> wasn&#39;t setup, requiring it in <code>B</code> results in an empty export object.  All the same, it can be a pain to debug, and not inherently obvious to developers used to having those circular dependencies handled automatically.  Fortunately, there are rather simple approaches to resolving the issue.

</p>
<h2>example.broken() === true</h2>
<p>Let&#39;s define a broken scenario to clearly illustrate the issue.  Module <code>A</code> delegates to an instance of Module <code>B</code> to <code>do some important stuff()</code>.

</p>
<h3>Module A</h3>
<pre><code class="lang-javascript"><span class="keyword">var</span> B = <span class="keyword">require</span>(<span class="string">'./B'</span>),
    id,
    bInstance;

<span class="keyword">var</span> A = module.exports = {
    init : <span class="keyword">function</span>(val) {
        id = val;
        bInstance = <span class="keyword">new</span> B();
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    doStuff : <span class="keyword">function</span>() {
        bInstance.stuff();
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    getId : <span class="keyword">function</span>() {
        <span class="keyword">return</span> id;
    }
};</code></pre>
<h3>Module B</h3>
<pre><code class="lang-javascript"><span class="keyword">var</span> A = <span class="keyword">require</span>(<span class="string">'./A'</span>);

<span class="keyword">var</span> B = module.exports = <span class="keyword">function</span>(){
    <span class="keyword">return</span> {
        stuff : <span class="keyword">function</span>() {
            console.log(<span class="string">'I got the id: '</span>, A.getId());
        }
    };
};</code></pre>
<h3>Tie them together</h3>
<pre><code class="lang-javascript"><span class="keyword">require</span>(<span class="string">'./A.js'</span>)
    .init(<span class="number">1234</span>)
    .doStuff();</code></pre>
<p>With this you&#39;ll end up with an error:
</p>
<pre><code class="lang-javascript">TypeError: Object <span class="comment">#&lt;Object> has no method 'getId'</span>
    at Object.stuff (/Users/bharris/workspace/circular-dep/B.js:<span class="number">7</span>:<span class="number">36</span>)
    at Object.doStuff (/Users/bharris/workspace/circular-dep/A.js:<span class="number">18</span>:<span class="number">13</span>)
    at Object.&lt;anonymous> (/Users/bharris/workspace/circular-dep/test.js:<span class="number">4</span>:<span class="number">3</span>)</code></pre>
<p>The issue is that when <code>A</code> is required at the top of <code>B</code>, it ends up being an empty object, which doesn&#39;t have a <code>getId</code> method.

</p>
<h2>example.solutions().length === 2</h2>
<p>I&#39;ll explain two simple solutions to this issue:

</p>
<ul>
<li><a href="#delay">delay invocation of dependency until runtime</a></li>
<li><a href="#inject">replace circular dependency with dependency injection</a></li>
</ul>
<p><a name="delay"></a>
</p>
<h2>delay invocation of dependency until runtime</h2>
<p>If we move the require statements to where they are needed at runtime, it will delay the execution of them, allowing for the exports to have been created properly.  In this example, we can get away with simply moving the <code>require(&#39;./B&#39;)</code> statement.

</p>
<h3>Module A</h3>
<pre><code class="lang-javascript"><span class="keyword">var</span> id,
    bInstance;

<span class="keyword">var</span> A = module.exports = {
    init : <span class="keyword">function</span>(val) {
        id = val;
        bInstance = <span class="keyword">new</span> <span class="keyword">require</span>(<span class="string">'./B'</span>)();
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    doStuff : <span class="keyword">function</span>() {
        bInstance.stuff();
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    getId : <span class="keyword">function</span>() {
        <span class="keyword">return</span> id;
    }
};</code></pre>
<p>This feels like a bit of bandaid to this particular problem, but perhaps is the right solution in some cases.

</p>
<p><a name="inject"></a>
</p>
<h2>replace circular dependency with dependency injection</h2>
<p>The only dependecy that <code>B</code> currently has on <code>A</code> is an id property it needs access to.  We could just pass the id into the constructor of <code>B</code>, but let&#39;s assume <code>A</code> is more significant to the operations <code>B</code> must perform, and a proper reference is required.  If we inject that dependency we&#39;ll allow for a loose coupling between the two modules, and have a slightly more elegant solution.  Zing!

</p>
<h3>Module A</h3>
<pre><code class="lang-javascript"><span class="keyword">var</span> B = <span class="keyword">require</span>(<span class="string">'./B'</span>),
    id,
    bInstance;

<span class="keyword">var</span> A = module.exports = {
    init : <span class="keyword">function</span>(val) {
        id = val;
        bInstance = <span class="keyword">new</span> B(<span class="keyword">this</span>);
        <span class="keyword">return</span> <span class="keyword">this</span>;
    },

    getId : <span class="keyword">function</span>() {
        <span class="keyword">return</span> id;
    },

    doStuff : <span class="keyword">function</span>() {
        bInstance.stuff();
        <span class="keyword">return</span> <span class="keyword">this</span>;
    }
};</code></pre>
<h3>Module B</h3>
<pre><code class="lang-javascript"><span class="keyword">var</span> B = module.exports = <span class="keyword">function</span>(val){
    <span class="keyword">var</span> dependency = val;
    <span class="keyword">return</span> {
        stuff : <span class="keyword">function</span>() {
            console.log(<span class="string">'I got the id: '</span>, dependency.getId());
        }
    };

};</code></pre>
<h3>#winning</h3>
<pre><code class="lang-javascript">DependencyInjection
    .merge(LooseCoupling)
    .attach($);</code></pre>
<p>I put my <code>$</code> on <a href="http://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> and <a href="http://en.wikipedia.org/wiki/Loose_coupling">loose coupling</a>.

</p>

</div><div class="comments"><div id="disqus_thread"></div><script type='text/javascript'>disqus_identifier='/2012/05/08/node-js-circular-dependencies';disqus_url='http://selfcontained.us/2012/05/08/node-js-circular-dependencies';</script><script type="text/javascript">var disqus_shortname = 'selfcontained';
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();

</script><noscript>	Please enable JavaScript to view the
<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a></div></article></section></div><footer>	&copy; 2012 Brad Harris |
	powered by
<a href="https://github.com/selfcontained/flipflop">flipflop</a></footer></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-254292-12']);
_gaq.push(['_trackPageview']);

(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script></body></html>