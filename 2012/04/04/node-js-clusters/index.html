<!DOCTYPE html><html lang="en"><head><title>node.js clusters</title><meta name="keywords" content="node.js,javascript"><meta name="author" content="Brad Harris"><meta name="robots" content="index,follow"><meta name="viewport" content="width=device-width,initial-scale=1"><link href="/css/blog.css" rel="stylesheet"><link rel="alternate" type="application/rss+xml" title="selfcontained Â» rss" href="http://www.selfcontained.us/feed/rss.xml"></head><body><div id="main"><header><h1><a href="/">selfcontained</a><small>[web development]</small></h1></header><div id="content-container"><section id="content"><article><h2><a href="/2012/04/04/node-js-clusters">node.js clusters</a></h2><div class="meta"><ul class="tags"><li><a href="/tag/node.js">node.js</a></li><li><a href="/tag/javascript">javascript</a></li></ul><img src="http://www.gravatar.com/avatar/c20763ec853bb1d2eb3e8a08cc5a28b9?s=30.jpg" width="30" height="30"><div class="date">Wednesday April 4, 2012</div><div class="name">By Brad Harris</div></div><div class="content"><p>When it comes time to deploy a <a href="http://nodejs.org">node.js</a> application, you&#39;ll want to examine how you can benefit from your hardware and take advantage of multiple cpus.  Node is single threaded, so having one process run your application on a server with more than one cpu isn&#39;t optimal.  Fortunately, like many things on node, it&#39;s simple to do so.

</p>
<p>Let&#39;s take the following example of a dead simple http server:

</p>
<pre><code class="lang-javascript">    <span class="keyword">require</span>(<span class="string">'http'</span>).createServer(<span class="keyword">function</span>(req, res) {
        res.writeHead(<span class="number">200</span>);
        res.end(<span class="string">'this is dead simple'</span>);
    }).listen(<span class="number">3001</span>);</code></pre>
<p>You&#39;ve got that saved in a file, let&#39;s call it <em>app.js</em>.  You start it up...

</p>
<pre><code>    &gt; node app.js</code></pre>
<p>...and it&#39;s amazing, it writes out text to all those that visit your site, just like you want.  It&#39;s become an overnight internet sensation, and now you want to know what crazy hoops you&#39;ll have to jump through to scale it up and take advantage of all the cpus on your server.  Enter the <a href="http://nodejs.org/docs/latest/api/cluster.html">cluster</a> module.

</p>
<p>We&#39;ll create a new file that we&#39;ll use in production to launch our application.  Let&#39;s call it <code>cluster.js</code>.

</p>
<pre><code class="lang-javascript">    <span class="keyword">var</span> cluster = <span class="keyword">require</span>(<span class="string">'cluster'</span>);

    <span class="keyword">if</span> (cluster.isMaster) {
        <span class="comment">//start up workers for each cpu</span>
        <span class="keyword">require</span>(<span class="string">'os'</span>).cpus().<span class="keyword">forEach</span>(<span class="keyword">function</span>() {
            cluster.fork();
        });

    } <span class="keyword">else</span> {
        <span class="comment">//load up your application as a worker</span>
        <span class="keyword">require</span>(<span class="string">'./app.js'</span>);
    }</code></pre>
<p>When you start your app now...

</p>
<pre><code>    &gt; node cluster.js</code></pre>
<p>...node will recognize that the cluster is the master, and then you simply fork the cluster for each cpu you have.  Those in turn will start up, and those workers won&#39;t be the master, so they&#39;ll just load up your <code>app.js</code> and start up a process for each cpu.

</p>
<p>But wait, doesn&#39;t each worker have to listen on a different port?

</p>
<blockquote>
<p>   &quot;The cluster module allows you to easily create a network of processes that all share server ports.&quot;

</p>
</blockquote>
<p>One TCP server is shared between all workers, so they can all be listening on the same port.

</p>
<p>Awesome, you&#39;re now handling loads of traffic, but after a day you realize two of your workers died because you had an exception being thrown in that complex codebase of yours.  How can you make sure you keep them running?

</p>
<pre><code class="lang-javascript">    <span class="keyword">if</span>(cluster.isMaster) {
        <span class="comment">//start up workers for each cpu</span>
        <span class="keyword">require</span>(<span class="string">'os'</span>).cpus().<span class="keyword">forEach</span>(<span class="keyword">function</span>() {
            cluster.fork();
        });

        cluster.on(<span class="string">'death'</span>, <span class="keyword">function</span>(worker) {
            console.log(<span class="string">'worker '</span> + worker.pid + <span class="string">' died'</span>);
            cluster.fork();
        });
    }</code></pre>
<p>Listen for the &#39;death&#39; event on the cluster, and just fork a new worker if one dies.  Simple huh?  Keep in mind, every worker is it&#39;s own process, therefor they don&#39;t share memory.

</p>

</div><div class="comments"><div id="disqus_thread"></div><script type='text/javascript'>disqus_identifier='/2012/04/04/node-js-clusters';disqus_url='http://selfcontained.us/2012/04/04/node-js-clusters';</script><script type="text/javascript">var disqus_shortname = 'selfcontained';
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();

</script><noscript>	Please enable JavaScript to view the
<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a></div></article></section><aside class="sidebar"><div class="about"><img src="/images/bradharris.gif" width="100" height="100" align="left"><p>	My name is Brad Harris and I'm an engineer @ Yahoo!
	I love architecting software and developing simple and elegant solutions to complex problems. I
	've worked for companies on large enterprise projects, as well as smaller projects, and fine satisfaction across the board.
	I enjoy learning and applying new principles and patterns to my work.
</p></div><h3>recent articles</h3><ul><li><a href="/2013/09/14/flipflop-0.1.0-configurable-urls">flipflop 0.1.0 - configurable urls</a><div class="date">Saturday September 14, 2013</div></li><li><a href="/2012/09/20/using-express-with-broadway">using express with broadway</a><div class="date">Thursday September 20, 2012</div></li><li><a href="/2012/09/18/decoupling-your-node-js-application-with-broadway">decoupling your node.js application with broadway</a><div class="date">Tuesday September 18, 2012</div></li><li><a href="/2012/09/01/hello-fabric">hello fabric</a><div class="date">Saturday September 1, 2012</div></li><li><a href="/2012/05/08/node-js-circular-dependencies">node.js and circular dependencies</a><div class="date">Tuesday May 8, 2012</div></li><li><a href="/2012/04/27/backup-iphoto-with-google-drive">google.drive.backup(iphoto.library)</a><div class="date">Friday April 27, 2012</div></li><li><a href="/2012/04/14/makdown-powered-blogs">markdown powered blogs</a><div class="date">Saturday April 14, 2012</div></li><li><a href="/2012/04/04/node-js-clusters">node.js clusters</a><div class="date">Wednesday April 4, 2012</div></li><li><a href="/2011/07/08/markdown-me">markdown.me</a><div class="date">Friday July 8, 2011</div></li><li><a href="/2011/05/28/phpunit-mocks-and-closures">PHPUnit, Mocks and Closures</a><div class="date">Saturday May 28, 2011</div></li><li><a href="/2011/04/20/php-and-an-abstract-singleton">PHP and an abstract Singleton</a><div class="date">Wednesday April 20, 2011</div></li><li><a href="/2011/04/20/review-yahoo-user-interface-library-2-x-cookbook">Review: Yahoo! User Interface Library 2.x Cookbook</a><div class="date">Wednesday April 20, 2011</div></li><li><a href="/2011/02/28/awaiting-yahoo-user-interface-library-2-x-cookbook">Awaiting Yahoo! User Interface Library 2.x Cookbook</a><div class="date">Monday February 28, 2011</div></li><li><a href="/2011/01/23/latest-endeavor-whoopdwhoop-com">Latest Endeavor: whoopdwhoop.com</a><div class="date">Sunday January 23, 2011</div></li><li><a href="/2010/11/30/php-coalesce">?: PHP Coalesce</a><div class="date">Tuesday November 30, 2010</div></li><li><a href="/2010/11/19/yui-jquery">YUI =&gt; jQuery?</a><div class="date">Friday November 19, 2010</div></li><li><a href="/2010/10/22/yahoo-new-adventure">Yahoo!  A New Adventure</a><div class="date">Friday October 22, 2010</div></li><li><a href="/2010/09/04/yui-2-8-learning-the-library-book-review">YUI 2.8 Learning the Library book review</a><div class="date">Saturday September 4, 2010</div></li><li><a href="/2010/08/13/yui-2-8-learning-the-library-free-chapter">&quot;YUI 2.8: Learning the Library&quot; Free Chapter</a><div class="date">Friday August 13, 2010</div></li><li><a href="/2010/05/08/first-iphone-app-lds-gems">First iPhone App - LDS Gems</a><div class="date">Saturday May 8, 2010</div></li><li><a href="/2010/03/30/doctrine-model-hydration">Doctrine Model Hydration</a><div class="date">Tuesday March 30, 2010</div></li><li><a href="/2009/09/16/getting-keycode-values-in-javascript">Getting keycode values in Javascript</a><div class="date">Wednesday September 16, 2009</div></li><li><a href="/2009/01/23/scoping-javascript-closures-in-loops">Scoping Javascript closures in loops</a><div class="date">Friday January 23, 2009</div></li><li><a href="/2009/01/23/browser-autocomplete-and-keyup-events">Browser autocomplete and keyup events</a><div class="date">Friday January 23, 2009</div></li><li><a href="/2009/01/22/followup-on-yui-getfirstdescendantby">Followup on YUI : getFirstDescendantBy()</a><div class="date">Thursday January 22, 2009</div></li></ul><h3>links</h3><ul><li><a href="/archive">archive</a></li><li><a href="/feed/rss.xml">feed</a></li></ul></aside></div><footer>	&copy; 2012 Brad Harris |
	powered by
<a href="https://github.com/selfcontained/flipflop">flipflop</a></footer></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-254292-12']);
_gaq.push(['_trackPageview']);

(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script></body></html>