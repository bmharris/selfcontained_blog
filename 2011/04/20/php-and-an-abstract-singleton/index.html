<!DOCTYPE html><html lang="en"><head><title>PHP and an abstract Singleton</title><meta name="keywords" content="php"><meta name="author" content="Brad Harris"><meta name="robots" content="index,follow"><meta name="viewport" content="width=device-width,initial-scale=0.5"><link href="/css/blog.css" rel="stylesheet"><link rel="alternate" type="application/rss+xml" title="selfcontained Â» rss" href="http://www.selfcontained.us/feed/rss.xml"></head><body><div id="main"><header><h1><a href="/">selfcontained</a><small>[web development]</small></h1></header><div id="content-container"><aside class="sidebar"><div class="about"><img src="/images/bradharris.gif" width="100" height="100" align="left"><p>	My name is Brad Harris and I'm an engineer @ Yahoo!
	I love architecting software and developing simple and elegant solutions to complex problems. I
	've worked for companies on large enterprise projects, as well as smaller projects, and find satisfaction across the board.
	I enjoy learning and applying new principles and patterns to my work.
</p></div><div class="recent-articles"><h3>recent articles</h3><ul><li><a href="/2014/01/14/modern-componentized-ui">talk on modern componentized ui</a><div class="date">Tuesday January 14, 2014</div></li><li><a href="/2013/09/14/flipflop-0.1.0-configurable-urls">flipflop 0.1.0 - configurable urls</a><div class="date">Saturday September 14, 2013</div></li><li><a href="/2012/09/20/using-express-with-broadway">using express with broadway</a><div class="date">Thursday September 20, 2012</div></li><li><a href="/2012/09/18/decoupling-your-node-js-application-with-broadway">decoupling your node.js application with broadway</a><div class="date">Tuesday September 18, 2012</div></li><li><a href="/2012/09/01/hello-fabric">hello fabric</a><div class="date">Saturday September 1, 2012</div></li><li><a href="/2012/05/08/node-js-circular-dependencies">node.js and circular dependencies</a><div class="date">Tuesday May 8, 2012</div></li><li><a href="/2012/04/27/backup-iphoto-with-google-drive">google.drive.backup(iphoto.library)</a><div class="date">Friday April 27, 2012</div></li><li><a href="/2012/04/14/makdown-powered-blogs">markdown powered blogs</a><div class="date">Saturday April 14, 2012</div></li><li><a href="/2012/04/04/node-js-clusters">node.js clusters</a><div class="date">Wednesday April 4, 2012</div></li><li><a href="/2011/07/08/markdown-me">markdown.me</a><div class="date">Friday July 8, 2011</div></li><li><a href="/2011/05/28/phpunit-mocks-and-closures">PHPUnit, Mocks and Closures</a><div class="date">Saturday May 28, 2011</div></li><li><a href="/2011/04/20/php-and-an-abstract-singleton">PHP and an abstract Singleton</a><div class="date">Wednesday April 20, 2011</div></li><li><a href="/2011/04/20/review-yahoo-user-interface-library-2-x-cookbook">Review: Yahoo! User Interface Library 2.x Cookbook</a><div class="date">Wednesday April 20, 2011</div></li><li><a href="/2011/02/28/awaiting-yahoo-user-interface-library-2-x-cookbook">Awaiting Yahoo! User Interface Library 2.x Cookbook</a><div class="date">Monday February 28, 2011</div></li><li><a href="/2011/01/23/latest-endeavor-whoopdwhoop-com">Latest Endeavor: whoopdwhoop.com</a><div class="date">Sunday January 23, 2011</div></li><li><a href="/2010/11/30/php-coalesce">?: PHP Coalesce</a><div class="date">Tuesday November 30, 2010</div></li><li><a href="/2010/11/19/yui-jquery">YUI =&gt; jQuery?</a><div class="date">Friday November 19, 2010</div></li><li><a href="/2010/10/22/yahoo-new-adventure">Yahoo!  A New Adventure</a><div class="date">Friday October 22, 2010</div></li><li><a href="/2010/09/04/yui-2-8-learning-the-library-book-review">YUI 2.8 Learning the Library book review</a><div class="date">Saturday September 4, 2010</div></li><li><a href="/2010/08/13/yui-2-8-learning-the-library-free-chapter">&quot;YUI 2.8: Learning the Library&quot; Free Chapter</a><div class="date">Friday August 13, 2010</div></li><li><a href="/2010/05/08/first-iphone-app-lds-gems">First iPhone App - LDS Gems</a><div class="date">Saturday May 8, 2010</div></li><li><a href="/2010/03/30/doctrine-model-hydration">Doctrine Model Hydration</a><div class="date">Tuesday March 30, 2010</div></li><li><a href="/2009/09/16/getting-keycode-values-in-javascript">Getting keycode values in Javascript</a><div class="date">Wednesday September 16, 2009</div></li><li><a href="/2009/01/23/scoping-javascript-closures-in-loops">Scoping Javascript closures in loops</a><div class="date">Friday January 23, 2009</div></li><li><a href="/2009/01/23/browser-autocomplete-and-keyup-events">Browser autocomplete and keyup events</a><div class="date">Friday January 23, 2009</div></li></ul></div><div class="links"><h3>links</h3><ul><li><a href="/archive">archive</a></li><li><a href="/feed/rss.xml">feed</a></li></ul></div></aside><section id="content"><article><h2><a href="/2011/04/20/php-and-an-abstract-singleton">PHP and an abstract Singleton</a></h2><div class="meta"><ul class="tags"><li><a href="/tag/php">php</a></li></ul><img src="http://www.gravatar.com/avatar/c20763ec853bb1d2eb3e8a08cc5a28b9?s=30.jpg" width="30" height="30"><div class="date">Wednesday April 20, 2011</div><div class="name">By Brad Harris</div></div><div class="content"><p>PHP is quirky.  I&#39;ve heard it called other things, but I&#39;ll leave it at that.  I had a great learning experience while writing an abstract singleton class.  Static binding in PHP behaves uniquely, and is often a hurdle when you try and develop an kind of an API using inheritance and static properties.  If you aren&#39;t familiar with static binding in PHP, <a href="http://us3.php.net/lsb">read the doc on late static binding</a> and it will give you a good overview.  This issue came up while creating an abstract singleton class.

</p>
<p>Let me explain by example.  Here&#39;s my first pass at a simple abstract singleton class that I could theoretically extend from other classes, and just pick up &quot;singleton&quot; behavior.  Disclaimer!!! Don&#39;t use this class, it doesn&#39;t work!

</p>
<pre><code class="lang-php"><span class="keyword">abstract</span> <span class="keyword">class</span> Singleton {

    <span class="keyword">private</span> <span class="keyword">static</span> <span class="variable">$instance</span> = <span class="keyword">null</span>;

    <span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">function</span> getInstance() {

        <span class="keyword">if</span>(<span class="keyword">static</span>::<span class="variable">$instance</span> === <span class="keyword">null</span>) {
            <span class="keyword">static</span>::<span class="variable">$instance</span> = <span class="keyword">new</span> <span class="keyword">static</span>();
        }
        <span class="keyword">return</span> <span class="keyword">static</span>::<span class="variable">$instance</span>;
    }

    <span class="keyword">protected</span> <span class="keyword">function</span> __construct() { }

}</code></pre>
<p>This worked, initially, until I created two classes that extended <code>Singleton</code> and found the second one I called behaved remarkably like the first one.

</p>
<pre><code class="lang-php"><span class="keyword">class</span> FirstSingleton <span class="keyword">extends</span> Singleton {
...
}
<span class="keyword">class</span> SecondSingleton <span class="keyword">extends</span> Singleton {
...
}</code></pre>
<p>Any calls to <code>SecondSingleton::getInstace()</code> were really just returning the <code>FirstSingleton</code> instance.  Since the <code>private static $instance</code> property is delcared on the abstract <code>Singleton</code> class, there was really just one <code>$instance</code> being stored across calls to <code>getInstance()</code> from various subclasses.  PHP doesn&#39;t bind the <code>$instance</code> property to the called class, it is bound to the class where it is declared, <code>Singleton</code> in this case.  You <em>could</em> declare the <code>$instance</code> property on all classes that extend <code>Singleton</code>, but that is defeating the point of the abstract class.  Here&#39;s round two, which does work, but I have mixed feelings about:

</p>
<pre><code class="lang-php"><span class="keyword">abstract</span> <span class="keyword">class</span> Singleton {

    <span class="keyword">private</span> <span class="keyword">static</span> <span class="variable">$instances</span>;

    <span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">function</span> getInstance() {
        <span class="variable">$className</span> = get_called_class();

        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">self</span>::<span class="variable">$instances</span>[<span class="variable">$className</span>]) == <span class="keyword">false</span>) {
            <span class="keyword">self</span>::<span class="variable">$instances</span>[<span class="variable">$className</span>] = <span class="keyword">new</span> <span class="keyword">static</span>();
        }
        <span class="keyword">return</span> <span class="keyword">self</span>::<span class="variable">$instances</span>[<span class="variable">$className</span>];
    }

    <span class="keyword">protected</span> <span class="keyword">function</span>  __construct() { }

}</code></pre>
<p>The change here is that instead of storing a single <code>$instance</code> property on the abstract <code>Singleton</code> class, we&#39;re storing an array of instances, indexed by the class name of the called class.  It behaves as expected, but the code isn&#39;t as clear or clean as I would have hoped it would be.

</p>

</div><div class="comments"><div id="disqus_thread"></div><script type='text/javascript'>disqus_identifier='/2011/04/20/php-and-an-abstract-singleton';disqus_url='http://selfcontained.us/2011/04/20/php-and-an-abstract-singleton';</script><script type="text/javascript">var disqus_shortname = 'selfcontained';
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();

</script><noscript>	Please enable JavaScript to view the
<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a></div></article></section></div><footer>	&copy; 2012 Brad Harris |
	powered by
<a href="https://github.com/selfcontained/flipflop">flipflop</a></footer></div><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-254292-12']);
_gaq.push(['_trackPageview']);

(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();

</script><div class="YAD-9a9f8d42-22f8-31d6-b8c4-54958e4eeba4"></div><script>(function(a,b,c,d,e,f){a[d]||(a[d]=
 function(){(a[d].q=a[d].q||[]).push([arguments,+new Date])});
 e=b.createElement(c);f=b.getElementsByTagName(c)[0];
 e.src='https://s.yimg.com/uq/syndication/yad.js';e.async=true;
 f.parentNode.insertBefore(e,f)}(window,document,'script','yad'));
 yad('9a9f8d42-22f8-31d6-b8c4-54958e4eeba4');

</script></body></html>